<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>éŸ³å£°èªè­˜ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        #log {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #result {
            background: white;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 5px;
            margin: 10px 0;
            min-height: 50px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤ éŸ³å£°èªè­˜ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
    
    <div id="status" class="status info">åˆæœŸåŒ–ä¸­...</div>
    
    <div>
        <button onclick="startRecognition()">éŸ³å£°èªè­˜é–‹å§‹</button>
        <button onclick="stopRecognition()">éŸ³å£°èªè­˜åœæ­¢</button>
        <button onclick="checkPermission()">ãƒã‚¤ã‚¯æ¨©é™ç¢ºèª</button>
        <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>
    
    <h3>èªè­˜çµæœ:</h3>
    <div id="result"></div>
    
    <h3>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°:</h3>
    <div id="log"></div>
    
    <script>
        let recognition = null;
        let isRecognizing = false;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + className;
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('result').textContent = '';
        }
        
        // åˆæœŸåŒ–
        function initializeRecognition() {
            log('éŸ³å£°èªè­˜ã®åˆæœŸåŒ–ã‚’é–‹å§‹');
            
            // Web Speech APIã®å­˜åœ¨ç¢ºèª
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                log('Web Speech APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                updateStatus('âŒ Web Speech APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return false;
            }
            
            log('Web Speech APIãŒåˆ©ç”¨å¯èƒ½ã§ã™');
            
            // SpeechRecognitionã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            try {
                recognition = new SpeechRecognition();
                log('SpeechRecognitionã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
            } catch (error) {
                log('SpeechRecognitionã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã«å¤±æ•—: ' + error.message, 'error');
                updateStatus('âŒ éŸ³å£°èªè­˜ã®åˆæœŸåŒ–ã«å¤±æ•—', 'error');
                return false;
            }
            
            // è¨­å®š
            recognition.lang = 'ja-JP';
            recognition.interimResults = true;
            recognition.continuous = true;
            recognition.maxAlternatives = 1;
            
            log('éŸ³å£°èªè­˜è¨­å®š:');
            log('  è¨€èª: ja-JP');
            log('  ä¸­é–“çµæœ: æœ‰åŠ¹');
            log('  é€£ç¶šèªè­˜: æœ‰åŠ¹');
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
            recognition.onstart = function() {
                isRecognizing = true;
                log('éŸ³å£°èªè­˜ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ', 'success');
                updateStatus('ğŸ”´ éŒ²éŸ³ä¸­...', 'success');
            };
            
            recognition.onend = function() {
                isRecognizing = false;
                log('éŸ³å£°èªè­˜ãŒçµ‚äº†ã—ã¾ã—ãŸ');
                updateStatus('â¹ï¸ åœæ­¢ä¸­', 'info');
            };
            
            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                        log('ç¢ºå®šçµæœ: ' + transcript);
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = '<strong>ç¢ºå®š:</strong> ' + finalTranscript + 
                                     '<br><strong>é€”ä¸­:</strong> <span style="color: #666;">' + 
                                     interimTranscript + '</span>';
            };
            
            recognition.onerror = function(event) {
                log('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ' + event.error, 'error');
                
                switch(event.error) {
                    case 'no-speech':
                        updateStatus('âš ï¸ éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                        break;
                    case 'audio-capture':
                        updateStatus('âŒ ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                        break;
                    case 'not-allowed':
                        updateStatus('âŒ ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'error');
                        break;
                    case 'network':
                        updateStatus('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼', 'error');
                        break;
                    default:
                        updateStatus('âŒ ã‚¨ãƒ©ãƒ¼: ' + event.error, 'error');
                }
                
                isRecognizing = false;
            };
            
            recognition.onnomatch = function() {
                log('éŸ³å£°ãŒèªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'warning');
            };
            
            recognition.onsoundstart = function() {
                log('éŸ³å£°æ¤œå‡ºé–‹å§‹');
            };
            
            recognition.onsoundend = function() {
                log('éŸ³å£°æ¤œå‡ºçµ‚äº†');
            };
            
            recognition.onspeechstart = function() {
                log('éŸ³å£°èªè­˜å‡¦ç†é–‹å§‹');
            };
            
            recognition.onspeechend = function() {
                log('éŸ³å£°èªè­˜å‡¦ç†çµ‚äº†');
            };
            
            updateStatus('âœ… æº–å‚™å®Œäº†', 'success');
            return true;
        }
        
        // éŸ³å£°èªè­˜é–‹å§‹
        function startRecognition() {
            if (!recognition) {
                log('éŸ³å£°èªè­˜ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                if (!initializeRecognition()) {
                    return;
                }
            }
            
            if (isRecognizing) {
                log('ã™ã§ã«éŸ³å£°èªè­˜ãŒå®Ÿè¡Œä¸­ã§ã™', 'warning');
                return;
            }
            
            try {
                recognition.start();
                log('éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...');
            } catch (error) {
                log('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—: ' + error.message, 'error');
                updateStatus('âŒ é–‹å§‹å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // éŸ³å£°èªè­˜åœæ­¢
        function stopRecognition() {
            if (!recognition) {
                log('éŸ³å£°èªè­˜ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            if (!isRecognizing) {
                log('éŸ³å£°èªè­˜ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            try {
                recognition.stop();
                log('éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¦ã„ã¾ã™...');
            } catch (error) {
                log('éŸ³å£°èªè­˜ã®åœæ­¢ã«å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // ãƒã‚¤ã‚¯æ¨©é™ç¢ºèª
        async function checkPermission() {
            log('ãƒã‚¤ã‚¯æ¨©é™ã‚’ç¢ºèªä¸­...');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™', 'success');
                updateStatus('âœ… ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯æ¸ˆã¿', 'success');
                
                // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                log('åˆ©ç”¨å¯èƒ½ãªãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹:');
                audioInputs.forEach((device, index) => {
                    log(`  ${index + 1}. ${device.label || 'ãƒã‚¤ã‚¯ ' + (index + 1)}`);
                });
                
                // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                stream.getTracks().forEach(track => track.stop());
            } catch (error) {
                log('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                updateStatus('âŒ ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦', 'error');
            }
        }
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', function() {
            log('ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº†');
            log('ãƒ–ãƒ©ã‚¦ã‚¶: ' + navigator.userAgent);
            log('ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ' + location.protocol);
            
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                log('è­¦å‘Š: HTTPSã§ãªã„ã¨éŸ³å£°èªè­˜ãŒå‹•ä½œã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™', 'warning');
            }
            
            initializeRecognition();
        });
    </script>
</body>
</html>